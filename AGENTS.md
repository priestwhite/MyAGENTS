# GEMINI.md  AI 工作規範

> 本檔為 AI 助理在此資料夾及子資料夾工作時的強制規範。

---

## 0. 優先序

```
使用者指示 > 子資料夾 AGENTS.md > 本檔 > README.md
```

**變體判斷**：讀取專案 `README.md` 的 Variant Tag（CLI/Web/hybrid）。若無標記，預設 CLI。

**處理問題流程**
AI 助手處理使用者需求時，應遵循第一性原理思考流程：
解構需求 (Deconstruct) - 分析使用者真正想解決的問題，而非僅看表面描述。
蒐集方案 (Research) - 結合已知知識、記憶與外部搜尋，找出可行解法。
驗證方案 (Verify) - 重新檢視方案是否符合原始需求。
討論確認 (Confirm) - 與使用者討論確認後再執行。

---

## 1. 強制規則

### 1.1 程式碼修改安全規則

> [!CAUTION]
> **違反此規則將導致不可逆的程式碼損失。**

修改任何程式碼時，必須遵循「註解化修改流程」：

| 步驟 | 動作 | 標記 |
|------|------|------|
| 1 | 將目標程式碼註解化（不刪除） | `# [DEPRECATED] 原因 - YYYY-MM-DD` |
| 2 | 在其下方寫入新程式碼 | `# [NEW] 說明 - YYYY-MM-DD` |
| 3 | 執行驗證（語法、功能、相依性） | - |
| 4 | 驗證通過 或 用戶允許後，才可移除舊碼 | - |

**完整性原則**：

- 禁止省略任何原有內文（含註解、空白行、docstring）
- 修改前後行數差異需向用戶說明

**例外**：

- 明顯錯字可直接修改
- 用戶明確說「直接改」或「不用保留舊碼」
- 純新增程式碼（無修改既有）

### 1.2 輸出規範

| 項目 | 規則 |
|------|------|
| 語言 | 繁體中文 |
| 結構 | 結論  步驟  建議（≤3 項） |
| 格式 | 命令/路徑/識別符用反引號 |
| 篇幅 | 精簡為主，必要時展開 |

### 1.3 禁止操作

- ❌ 提交 `.env`、`config.ini`（若含憑證）
- ❌ 未經備份即刪檔/更名
- ❌ 硬編碼絕對路徑
- ❌ 依賴當前工作目錄（CWD）

---

## 2. 標準流程

### 2.1 任務開始時

1. 讀取專案 `README.md` 確認變體與上下文
2. 檢查子資料夾是否有 `AGENTS.md` 覆蓋規則
3. 多步任務需持續更新進度狀態

### 2.2 任務進行中

- 變更功能/欄位/端點時，同步更新 `README.md` 與 `error.md`
- 遇到阻塞或不確定時，詢問用戶而非猜測
- 錯誤發生時記錄至 `error.md`

### 2.3 任務結束時

- 確認變更已同步至文檔
- 若有未解決問題，記錄於 `error.md` 標記為 🔄 或 ❌

---

## 3. 專案結構

### 3.1 必備文件

| 檔案 | 用途 | 必備 |
|------|------|------|
| `README.md` | 專案文檔（含 Variant Tag） | ✅ |
| `error.md` | 問題追蹤 | ✅ |
| `config.ini` | 設定（勿含憑證） | ✅ |
| `requirements.txt` | Python 依賴 | ✅ |
| `logs/` | 日誌目錄（加入 .gitignore） | ✅ |
| `.env.example` | 環境變數範本（脫敏） | 建議 |

### 3.2 變體結構

| 變體 | 核心目錄 | 日誌格式 | 驗證指令 |
|------|----------|----------|----------|
| CLI | `src/` | text（DEBUG 用 jsonl） | `pytest src/` |
| Web | `routes/`, `templates/`, `data/` | jsonl | `pytest data/` |
| hybrid | 依功能混合 | jsonl | `pytest` |

---

## 4. 程式碼風格

### 4.1 命名

| 類型 | 慣例 | 範例 |
|------|------|------|
| 變數 | `snake_case`，語義明確 | `user_list`, `is_valid` |
| 函數 | 動詞開頭 | `check_auth()`, `get_user()` |
| 時間欄位 | `*_at` 結尾 | `created_at`, `updated_at` |

### 4.2 原則

- 單檔單功能
- 簡單勝過複雜
- 程式碼自說明
- 行為可追溯（預留日誌）
- 跨平台使用 `pathlib.Path`

---

## 5. 刪檔/更名流程

1. 備份原檔（`.bak` 或移至 `archive/`）
2. 搜尋所有參照：`Select-String -Path "*.py" -Pattern "舊檔名"`
3. 更新相關 import 語句
4. 同步更新 `README.md`
5. 執行測試：`pytest`
6. 提交（commit message 說明原因）

---

## 6. error.md 格式

| 時間 | 錯誤摘要 | 影響範圍 | 處置方式 | 狀態 |
|------|----------|----------|----------|------|
| YYYY-MM-DD | 描述 | 模組名 | 解法 | ✅/🔄/❌ |

- ✅ 已解決 / 🔄 進行中 / ❌ 未解決
- 定期清理已解決超過 30 天的條目

---

## 7. MCP 功能（條件觸發）

> 僅適用於支援 MCP 且 MCP001/002/003 模組正常運作的環境。

### 觸發條件

| 類型 | 觸發方式 |
|------|----------|
| SQL 操作 | `mysql_dry_run()` 預檢後 `mysql_execute()` |
| 記憶操作 | `memory_add/query/update` |

### 長期記憶策略

- 先查 hybrid 模式，不足則讀原檔摘要寫回
- 任務流程：Bootstrap  Decision  Wrap-up
- 憑證只存鍵名，不存值
- 清理：`memory_cleanup(30 days)`

---

## 8. 檢核清單

完成任務前確認：

- [ ] 輸出為繁體中文？
- [ ] 只修改相關檔案？
- [ ] 已同步 README/error.md？
- [ ] 採用簡單方案？
- [ ] 程式碼修改遵循註解化流程？
- [ ] 跨平台相容（pathlib）？
